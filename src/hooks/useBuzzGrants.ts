// Â© 2025 Joseph MULÃ‰ â€“ M1SSIONâ„¢
// @ts-nocheck

import { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';

interface BuzzGrant {
  id: string;
  source: string;
  remaining: number;
  created_at: string;
}

export const useBuzzGrants = () => {
  const [grants, setGrants] = useState<BuzzGrant[]>([]);
  const [totalRemaining, setTotalRemaining] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [dailyUsed, setDailyUsed] = useState(false); // Â© 2025 M1SSIONâ„¢ NIYVORA KFT â€“ Joseph MULÃ‰

  const fetchGrants = async () => {
    setIsLoading(true);
    setError(null);

    try {
      // Â© 2025 M1SSIONâ„¢ NIYVORA KFT â€“ Joseph MULÃ‰ - Check if user has already consumed daily free BUZZ today
      const today = new Date().toISOString().split('T')[0];
      
      // Check user_buzz_counter for today's free BUZZ usage
      const { data: todayBuzzUsage, error: buzzError } = await supabase
        .from('user_buzz_counter')
        .select('*')
        .eq('user_id', (await supabase.auth.getUser()).data.user?.id)
        .eq('counter_date', today)
        .single();

      // Â© 2025 M1SSIONâ„¢ - Fixed: use daily_count instead of buzz_count
      if (todayBuzzUsage && todayBuzzUsage.daily_count > 0) {
        setDailyUsed(true);
      } else {
        setDailyUsed(false);
      }

      const { data, error } = await supabase
        .from('buzz_grants')
        .select('*')
        .gt('remaining', 0)
        .order('created_at', { ascending: false });

      if (error) throw error;

      setGrants(data || []);
      const total = (data || []).reduce((sum, grant) => sum + grant.remaining, 0);
      setTotalRemaining(total);
    } catch (err) {
      console.error('Error fetching buzz grants:', err);
      setError(err instanceof Error ? err.message : 'Unknown error');
      setGrants([]);
      setTotalRemaining(0);
    } finally {
      setIsLoading(false);
    }
  };

  const consumeFreeBuzz = async (): Promise<boolean> => {
    if (totalRemaining <= 0) {
      console.log('âŒ No free buzz grants remaining');
      return false;
    }

    try {
      const userId = (await supabase.auth.getUser()).data.user?.id;
      
      if (!userId) {
        console.error('âŒ No user ID found');
        return false;
      }

      // Find the first grant with remaining buzz
      const grantToUse = grants.find(g => g.remaining > 0);
      if (!grantToUse) {
        console.log('âŒ No grant found with remaining buzz');
        return false;
      }

      console.log('ðŸŽ CONSUMING FREE BUZZ GRANT:', grantToUse.id, 'Remaining:', grantToUse.remaining);

      const { error } = await supabase
        .from('buzz_grants')
        .update({ 
          remaining: grantToUse.remaining - 1,
          updated_at: new Date().toISOString()
        })
        .eq('id', grantToUse.id);

      if (error) throw error;

      // ðŸ”¥ FIX: SAVE CLUE TO DATABASE - Let clue_id be generated by DB (gen_random_uuid())
      const uniqueClue = `Cerca dove l'innovazione italiana splende (${new Date().toLocaleTimeString()}) - FREE BUZZ`;
      
      console.log('ðŸ’¾ SAVING FREE BUZZ CLUE TO DATABASE');
      
      const { error: clueError } = await supabase
        .from('user_clues')
        .insert({
          user_id: userId,
          title_it: "ðŸŽ Indizio BUZZ Gratuito",
          description_it: uniqueClue,
          clue_type: "buzz",
          buzz_cost: 0,
          metadata: { 
            free_buzz_token: `free_buzz_${Date.now()}`,
            source: 'buzz_grant'
          }
        });

      if (clueError) {
        console.error('âŒ Error saving free buzz clue:', clueError);
      } else {
        console.log('âœ… FREE BUZZ CLUE SAVED TO DATABASE');
      }

      // SAVE NOTIFICATION TOO
      const { error: notifError } = await supabase
        .from('user_notifications')
        .insert({
          user_id: userId,
          type: 'buzz',
          title: 'ðŸŽ Nuovo Indizio BUZZ Gratuito!',
          message: uniqueClue,
          is_read: false,
          metadata: { free: true, source: 'buzz_grant' }
        });

      if (notifError) {
        console.error('âŒ Error saving free buzz notification:', notifError);
      } else {
        console.log('âœ… FREE BUZZ NOTIFICATION SAVED');
      }

      // ðŸ”¥ TRIGGER REALTIME UPDATE by also updating user_mission_status
      const { error: statusUpdateError } = await supabase
        .from('user_mission_status')
        .upsert({
          user_id: userId,
          clues_found: 1,
          mission_progress_percent: Math.round((1 / 200) * 100),
          updated_at: new Date().toISOString()
        });

      if (statusUpdateError) {
        console.error('âŒ Error triggering mission status update:', statusUpdateError);
      } else {
        console.log('âœ… MISSION STATUS UPDATE TRIGGERED');
      }

      // Mark daily usage immediately
      setDailyUsed(true);
      
      // Refresh grants after consumption
      await fetchGrants();
      return true;
    } catch (err) {
      console.error('Error consuming free buzz:', err);
      return false;
    }
  };

  useEffect(() => {
    fetchGrants();
  }, []);

  return {
    grants,
    totalRemaining,
    isLoading,
    error,
    fetchGrants,
    consumeFreeBuzz,
    hasFreeBuzz: totalRemaining > 0, // ðŸ”¥ FIX: Only check totalRemaining, remove dailyUsed restriction
    dailyUsed
  };
};