// ¬© 2025 Joseph MUL√â ‚Äì M1SSION‚Ñ¢ ‚Äì ALL RIGHTS RESERVED ‚Äì NIYVORA KFT‚Ñ¢
// M1SSION‚Ñ¢ - PWA Native Utility Functions

import { NavigateFunction } from 'react-router-dom';

// PWA Navigation handler
export const pwaNavigationHandler = (
  path: string, 
  navigate: NavigateFunction
) => {
  console.log('üß≠ PWA navigation to:', path);
  
  try {
    navigate(path, { replace: false });
    console.log('‚úÖ Navigation completed successfully');
  } catch (error) {
    console.error('‚ùå Navigation error:', error);
    navigate('/home', { replace: true });
  }
};

// PWA Authentication handler
export const pwaAuthHandler = (
  action: 'login' | 'logout' | 'register', 
  navigate: NavigateFunction
) => {
  console.log('üîê PWA auth action:', action);
  
  try {
    switch (action) {
      case 'login':
        navigate('/login', { replace: false });
        break;
      case 'logout':
        localStorage.removeItem('m1ssion-intro-completed');
        navigate('/', { replace: true });
        break;
      case 'register':
        navigate('/register', { replace: false });
        break;
      default:
        navigate('/', { replace: true });
    }
    console.log('‚úÖ Auth navigation completed');
  } catch (error) {
    console.error('‚ùå Auth navigation error:', error);
    navigate('/', { replace: true });
  }
};

// PWA Environment detection
export const isPWAEnvironment = (): boolean => {
  if (typeof window === 'undefined') return false;
  
  const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
    (window.navigator as any).standalone === true ||
    document.referrer.includes('android-app://');
  
  console.log('üì± PWA Environment Detection:', { isPWA });
  return isPWA;
};

// PWA Safe area utilities
export const getPWASafeAreaInsets = () => {
  if (typeof window === 'undefined') {
    return { top: 0, bottom: 0, left: 0, right: 0 };
  }
  
  const getInset = (side: string) => {
    const value = getComputedStyle(document.documentElement)
      .getPropertyValue(`--safe-area-inset-${side}`)
      .trim();
    
    if (value && value !== `env(safe-area-inset-${side})`) {
      return parseInt(value.replace('px', '')) || 0;
    }
    
    return 0;
  };
  
  return {
    top: getInset('top'),
    bottom: getInset('bottom'),
    left: getInset('left'),
    right: getInset('right')
  };
};

// PWA Device orientation
export const getPWADeviceOrientation = () => {
  if (typeof window === 'undefined') return 'portrait';
  
  if (window.screen?.orientation) {
    return window.screen.orientation.type;
  }
  
  return window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
};

// PWA Touch gestures optimization
export const optimizePWATouchGestures = () => {
  if (typeof window === 'undefined') return;
  
  console.log('üö´ Optimizing PWA touch gestures...');
  
  // Prevent double-tap zoom
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = new Date().getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  
  // üî• FIX: Remove all overscroll blocks for native pull-to-refresh
  // Note: PWA standalone on iOS never has native pull-to-refresh
  document.body.style.overscrollBehavior = 'auto';
  document.body.style.touchAction = 'pan-x pan-y';
  
  console.log('‚úÖ PWA touch gestures optimized');
};

// PWA Initialization
export const initializePWA = async () => {
  console.log('üì± Initializing PWA environment...');
  
  try {
    // Optimize touch gestures
    optimizePWATouchGestures();
    
    // Set PWA-friendly meta tags
    const viewport = document.querySelector('meta[name="viewport"]');
    if (viewport) {
      viewport.setAttribute('content', 
        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover'
      );
    }
    
    console.log('‚úÖ PWA initialization completed');
    return true;
    
  } catch (error) {
    console.error('‚ùå PWA initialization error:', error);
    return false;
  }
};

console.log('‚úÖ M1SSION PWA functions loaded');