<!DOCTYPE html>
<html>
<head>
    <title>M1SSIONâ„¢ Push Test Direct</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #00ff00; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #00ff00; }
        .error { border-left-color: #ff0000; color: #ff0000; }
        .success { border-left-color: #00ff00; color: #00ff00; }
        .info { border-left-color: #0099ff; color: #0099ff; }
        button { background: #00ff00; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ§ª M1SSIONâ„¢ Direct Push Test</h1>
    <div id="logs"></div>
    
    <button onclick="testDirectCall()">ğŸ”¥ Test Edge Function Direct</button>
    <button onclick="testWithRealSubscription()">ğŸ“± Test With Real Subscription</button>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        async function testDirectCall() {
            log('ğŸ”¬ Testing edge function direct call...', 'info');
            
            try {
                const response = await fetch('https://vkjrqirvdvjbemsfzxof.supabase.co/functions/v1/send-push-canary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk'
                    },
                    body: JSON.stringify({
                        title: 'DIRECT TEST',
                        body: 'Direct function test',
                        data: { test: true }
                    })
                });
                
                log(`ğŸ“¡ Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… Success: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`âŒ Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Network error: ${error.message}`, 'error');
            }
        }
        
        async function testWithRealSubscription() {
            log('ğŸ“± Testing with real subscription from DB...', 'info');
            
            try {
                const response = await fetch('https://vkjrqirvdvjbemsfzxof.supabase.co/functions/v1/send-push-canary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk'
                    },
                    body: JSON.stringify({
                        endpoint: 'https://web.push.apple.com/QKldQeVN4FqjKs_2kfj3OxLh_9mZe-D9LY32F6cgojejyxYC9Q06HfCARdDXgZquHG5GYAmd9Mv6NjAztPO8tnHyyfwezPNuN3kkxH-8fKR7ZThy-Y-3Y0BusLnoQMboqDBueOXHRBn6B4jgYghx3Tkw-Nl_CThI4R8tcAZS3Fg',
                        title: 'M1SSIONâ„¢ REAL TEST ğŸš€',
                        body: 'Push notification funzionante al 100%!',
                        data: { 
                            url: '/ios-check.html',
                            timestamp: Date.now(),
                            test: 'real_subscription'
                        }
                    })
                });
                
                log(`ğŸ“¡ Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“¡ Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… Success: ${JSON.stringify(result, null, 2)}`, 'success');
                    
                    if (result.sent > 0) {
                        log(`ğŸ‰ ${result.sent} notifications sent! Check your iPhone!`, 'success');
                    }
                } else {
                    const errorText = await response.text();
                    log(`âŒ Error ${response.status}: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Network error: ${error.message}`, 'error');
            }
        }
        
        log('ğŸ”¥ Direct test ready! Ora testa la funzione edge direttamente.', 'success');
    </script>
</body>
</html>