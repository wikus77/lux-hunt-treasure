<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push Health - M1SSIONâ„¢</title>
  <style>
    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
      margin: 0;
    }
    .status { margin: 10px 0; }
    .ok { color: #0f0; }
    .error { color: #f00; }
    .info { color: #0af; }
    button {
      background: #333;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background: #0f0; color: #000; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background: #111; padding: 10px; border-radius: 4px; }
    #results { min-height: 200px; }
  </style>
</head>
<body>
  <h1>ðŸ”§ Push Health Diagnostic</h1>
  <p>End-to-end push notification testing</p>
  
  <div class="status">
    <button id="subscribeBtn">Subscribe</button>
    <button id="canaryBtn">Send Canary</button>
    <button id="apnsCanaryBtn">Canary APNs (edge)</button>
    <button id="unsubscribeBtn">Unsubscribe</button>
    <button id="clearBtn">Clear Log</button>
  </div>
  
  <div class="status">
    <h3>Current Subscription:</h3>
    <pre id="subscription">Checking...</pre>
  </div>
  
  <div class="status">
    <h3>Results:</h3>
    <pre id="results">Ready for testing...</pre>
  </div>

  <script type="module">
    const EDGE = 'https://vkjrqirvdvjbemsfzxof.functions.supabase.co';
    const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk';
    
    const log = (msg) => {
      const results = document.getElementById('results');
      results.textContent += new Date().toISOString() + ': ' + msg + '\n';
      results.scrollTop = results.scrollHeight;
    };

    function b64uToUint8(s) {
      const p = '='.repeat((4 - (s.length % 4)) % 4);
      return Uint8Array.from(atob(s.replace(/-/g, '+').replace(/_/g, '/') + p), c => c.charCodeAt(0));
    }

    window.ensurePushSubscription = async function() {
      try {
        log('ðŸš€ Starting push subscription...');
        
        if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
          throw new Error('Web Push non supportato');
        }
        
        const perm = await Notification.requestPermission();
        log(`ðŸ“± Permission: ${perm}`);
        if (perm !== 'granted') throw new Error(`Permission ${perm}`);
        
        const reg = (await navigator.serviceWorker.getRegistration('/')) || 
                     (await navigator.serviceWorker.register('/sw.js', { scope: '/' }));
        await navigator.serviceWorker.ready;
        log('âœ… Service Worker ready');
        
        // VAPID dall'edge
        log('ðŸ”‘ Getting VAPID key...');
        const r = await fetch(`${EDGE}/get-vapid`, { 
          headers: { 
            Authorization: `Bearer ${ANON}`, 
            apikey: ANON 
          } 
        });
        if (!r.ok) throw new Error(`get-vapid ${r.status}`);
        const { publicKey } = await r.json();
        if (!publicKey) throw new Error('VAPID publicKey mancante');
        log(`ðŸ”‘ VAPID key received (${publicKey.length} chars)`);
        
        // subscribe
        log('ðŸ“± Subscribing to push...');
        const sub = await reg.pushManager.subscribe({ 
          userVisibleOnly: true, 
          applicationServerKey: b64uToUint8(publicKey) 
        });
        log('âœ… Push subscription created');
        
        // invio a edge
        log('ðŸ’¾ Saving subscription...');
        const resp = await fetch(`${EDGE}/push_subscribe`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            Authorization: `Bearer ${ANON}`, 
            apikey: ANON 
          },
          body: JSON.stringify({ subscription: sub, ua: navigator.userAgent })
        });
        if (!resp.ok) throw new Error(`push_subscribe ${resp.status}`);
        
        const result = await resp.json();
        log(`âœ… Subscription saved: ${JSON.stringify(result)}`);
        return { sub: result };
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
        throw error;
      }
    };

    async function sendCanary() {
      try {
        log('ðŸ§ª Sending canary push...');
        const resp = await fetch(`${EDGE}/send-push-canary`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${ANON}`,
            apikey: ANON,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dry: false,
            title: 'Diag',
            body: 'It works!'
          })
        });
        
        if (!resp.ok) throw new Error(`send-push-canary ${resp.status}`);
        const result = await resp.json();
        log(`ðŸ“¤ Canary result: ${JSON.stringify(result)}`);
      } catch (error) {
        log(`âŒ Canary error: ${error.message}`);
      }
    }

    async function sendApnsCanary() {
      try {
        log('ðŸŽ Sending APNs minimal canary...');
        const resp = await fetch(`${EDGE}/send-push-canary?apns_minimal=1`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${ANON}`,
            apikey: ANON,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dry: false,
            title: 'APNs Test',
            body: 'Minimal APNs canary!'
          })
        });
        
        if (!resp.ok) throw new Error(`send-apns-canary ${resp.status}`);
        const result = await resp.json();
        log(`ðŸ“¤ APNs Canary result: ${JSON.stringify(result)}`);
      } catch (error) {
        log(`âŒ APNs Canary error: ${error.message}`);
      }
    }

    function clearLog() {
      document.getElementById('results').textContent = 'Log cleared...\n';
    }

    // Event listeners
    async function checkSubscriptionStatus() {
      try {
        const reg = await navigator.serviceWorker.getRegistration('/');
        if (!reg) {
          document.getElementById('subscription').textContent = 'No service worker';
          return;
        }
        
        const sub = await reg.pushManager.getSubscription();
        if (!sub) {
          document.getElementById('subscription').textContent = 'No subscription';
          return;
        }
        
        const host = new URL(sub.endpoint).host;
        const type = host === 'web.push.apple.com' ? 'APNs' : 
                    host.includes('fcm.googleapis.com') ? 'FCM' : 'Unknown';
        
        document.getElementById('subscription').textContent = 
          `Type: ${type}\nEndpoint: ${sub.endpoint.substring(0, 80)}...`;
      } catch (error) {
        document.getElementById('subscription').textContent = `Error: ${error.message}`;
      }
    }

    async function unsubscribe() {
      try {
        log('ðŸ”• Unsubscribing...');
        const reg = await navigator.serviceWorker.getRegistration('/');
        if (!reg) {
          log('âŒ No service worker');
          return;
        }
        
        const sub = await reg.pushManager.getSubscription();
        if (!sub) {
          log('âŒ No subscription');
          return;
        }
        
        await sub.unsubscribe();
        log('âœ… Browser unsubscribed');
        
        // DELETE from database
        const resp = await fetch(`${EDGE}/push_unsubscribe`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${ANON}`,
            apikey: ANON,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ endpoint: sub.endpoint })
        });
        
        if (!resp.ok) {
          log(`âŒ Database delete failed: ${resp.status}`);
        } else {
          log('âœ… Database record deleted');
        }
        
        checkSubscriptionStatus();
      } catch (error) {
        log(`âŒ Unsubscribe error: ${error.message}`);
      }
    }

    document.getElementById('subscribeBtn').addEventListener('click', () => {
      window.ensurePushSubscription().then(() => checkSubscriptionStatus()).catch(console.error);
    });

    document.getElementById('canaryBtn').addEventListener('click', sendCanary);
    document.getElementById('apnsCanaryBtn').addEventListener('click', sendApnsCanary);
    document.getElementById('unsubscribeBtn').addEventListener('click', unsubscribe);
    document.getElementById('clearBtn').addEventListener('click', clearLog);

    checkSubscriptionStatus();
    log('ðŸŽ¯ Push Health loaded - click Subscribe to start');
  </script>
</body>
</html>