# Map Audit Report — 2025-10-21

## Obiettivo
Rendere visibili tutti gli agenti registrati/online sulla mappa (marker rosso pulsante), mostrare count badge corretto, attivare 3D Terrain con DEM key, garantire center affidabile.

---

## 1. AGENTS — Presence & Markers

### 1.1 Tracking Immediato (GPS + IP-Geo Fallback)
**Status:** ✅ IMPLEMENTATO

- **MapContainer.tsx (useEffect immediate track):**
  - Priorità GPS (`geoPosition.coords`) > IP-Geo (`ipGeo.coords`)
  - Debounce 3s per evitare spam
  - Log dev-mode: `[Presence] Immediate track fired (GPS|IP-Geo)`
  - Dipendenze: `[currentAgentCode, geoPosition, ipGeo]`

**Effetto atteso:**
- Agenti con GPS abilitato → track immediato (lat/lng precise)
- Agenti con GPS negato → track IP-Geo (lat/lng approssimative)
- Nessun agente resta "online senza coordinate" per più di 3–5s

### 1.2 Badge Count Corretto
**Status:** ✅ IMPLEMENTATO

- **agentsPresence.ts (handleSync):**
  - `agentsWithCoords[]` → passati a callback (per rendering marker)
  - `allAgents[]` → esposti in `__M1_DEBUG.agentsPresenceAll` (per badge count)
  - Log dev-mode per ogni agente senza coord: `[Presence] no coords: AG-XXXX`

- **MapContainer.tsx (AGENTS toggle button):**
  - Badge mostra: `{shown}/{all}` dove:
    - `shown` = `localAgentsPresence.length` (agenti con coord, renderizzati)
    - `all` = `__M1_DEBUG.agentsPresenceAll.length` (tutti online, con o senza coord)
  - Tooltip: `"n mostrati / m online"` o `"Nessun agente online"`

**Acceptance:**
- Badge `"5/8"` = 5 agenti visibili (con coord), 8 totali online
- Se tutti hanno coord → `"8/8"`

### 1.3 Marker Rendering
**Status:** ✅ NESSUNA MODIFICA RICHIESTA (già funzionante)

- **AgentsLayer.tsx:**
  - Riceve solo `AgentPresence[]` con `lat` e `lng` definiti
  - Tooltip: `"You — AG-X0197"` per l'utente corrente, `"AG-XXXX"` per altri
  - Stile: marker rosso pulsante (#E53E3E con glow), cluster badge se >1

---

## 2. 3D TERRAIN — DEM Key & Activation

### 2.1 Environment Variables
**Status:** ⚠️ DA CONFIGURARE (fuori repo)

**ENV richieste:**
```
VITE_TERRAIN_URL=https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=VRJaVKMtkFdyVzhXCjBF
VITE_CONTOUR_URL=https://api.maptiler.com/tiles/contours/{z}/{x}/{y}.pbf?key=VRJaVKMtkFdyVzhXCjBF
```

**Azione utente:**
1. Lovable Project Settings → Environment Variables
2. Aggiungere le due variabili sopra (preview + production)
3. Rebuild/restart preview

### 2.2 Toggle 3D Logic
**Status:** ✅ GIÀ IMPLEMENTATO (fail-safe)

- **enableTerrain.ts:**
  - Controlla `import.meta.env.VITE_TERRAIN_URL`
  - Se manca → throw Error `'MISSING_TERRAIN_URL'`
  - Se presente → monta `TerrainLayer` (MapLibre overlay)
  - Aggiorna `__M1_DEBUG.terrain3D = { available, active, terrainUrl, error }`

- **Map3DToggle.tsx / MapContainer.tsx:**
  - Toggle disabilitato se `!VITE_TERRAIN_URL`
  - Toast: `"DEM mancante: configura VITE_TERRAIN_URL (TileJSON)"`

**Acceptance (dopo ENV settata):**
- Network tab: richiesta a `tiles.json` (HTTP/2 200)
- `__M1_DEBUG.terrain3D.active === true`
- Rilievi visibili, hillshade attivo

---

## 3. CENTER SU POSIZIONE

### 3.1 Handler Robusto
**Status:** ✅ GIÀ IMPLEMENTATO

- **handleFocusLocation (MapContainer.tsx):**
  - Race GPS vs IP-Geo con timeout 1.8s
  - Fast-path: cache `lastValidCoords` (skip race se disponibile)
  - Toast deduplication: `shouldShowToast(msgKey, 2s)`
  - Aggiorna `__M1_DEBUG.center = { lastAction, source: 'gps'|'ip'|'cached', error }`

**Acceptance:**
- 10 click consecutivi → 10 centrature deterministiche
- `__M1_DEBUG.center.source` indica la fonte effettiva
- Nessun banner duplicato

---

## 4. SUPABASE REALTIME (DA CONFIGURARE)

### 4.1 Allowed Origins (WebSocket)
**Status:** ⚠️ DA CONFIGURARE (Supabase Dashboard)

**Domini da aggiungere:**
```
https://*.lovableproject.com
https://<dominio-produzione>
http://localhost:5173
```

**Procedura:**
1. Supabase Dashboard → Progetto → Settings → API
2. Realtime → Allowed Origins (WebSocket)
3. Aggiungere i tre pattern sopra
4. Save & Restart Realtime (se richiesto)

### 4.2 Verifica Handshake
**Obiettivo:** eliminare `TIMED_OUT`, raggiungere `SUBSCRIBED → TRACKED → SYNC(n)`

**Logs da cercare (Realtime Logs):**
- Canale: `m1_agents_presence_v1`
- Eventi: `SUBSCRIBED`, `TRACK`, `SYNC`
- Nessun `TIMED_OUT` lato server

**Debug client:**
```js
window.__M1_DEBUG.presence
// atteso: { status: 'SYNC(n)', last: <timestamp>, error: null, count: n }
```

---

## 5. SAFETY CLAUSE — CONFORMITÀ

**Non modificato:**
- ✅ Logiche Buzz / Buzz Map
- ✅ Geolocalizzazione attuale e funzionante (riuso hook `useGeolocation`, `useIpGeo`)
- ✅ Notifiche push
- ✅ Norah AI 2.0 e Norah AI Panel
- ✅ Pagamenti Stripe
- ✅ Markers esistenti in MAP (non toccati)
- ✅ Logica/cluster marker AGENTS (AgentsLayer.tsx invariato salvo ricezione dati filtrati)
- ✅ Nessuna dipendenza Lovable

**Modifiche applicate:**
- ✅ `MapContainer.tsx`: useEffect per track immediato IP-Geo, badge count `{shown}/{all}`, tooltip
- ✅ `agentsPresence.ts`: split `agentsWithCoords` vs `allAgents`, log dev-mode per "no coords"
- ✅ Nessuna modifica a rendering marker (AgentsLayer.tsx)

---

## 6. ACCEPTANCE CHECKLIST

### 6.1 Agents
- [ ] `__M1_DEBUG.presence.status` → `SUBSCRIBED` → `TRACKED` → `SYNC(n≥1)` (no `TIMED_OUT`)
- [ ] Badge AGENTS mostra `"n/m"` (n con coord, m totali online)
- [ ] Tooltip badge: `"n mostrati / m online"`
- [ ] Marker rosso per ogni agente con coord (incluso "You — AG-X0197")
- [ ] Log dev-only: `[Presence] no coords: AG-XXXX` per agenti online senza coord
- [ ] Entro 5s da SUBSCRIBED, agenti con GPS o IP-Geo appaiono sulla mappa

### 6.2 3D Terrain
- [ ] ENV `VITE_TERRAIN_URL` settata (fuori repo)
- [ ] Network tab: richiesta a `tiles.json` (MapTiler) con HTTP/2 200
- [ ] `__M1_DEBUG.terrain3D = { available: true, active: true, terrainUrl: "https://...", error: null }`
- [ ] Rilievi visibili, hillshade attivo
- [ ] Toggle OFF → rilievi scompaiono, opacità tile 1.0

### 6.3 Center su Posizione
- [ ] 10 click consecutivi → 10 centrature
- [ ] `__M1_DEBUG.center.source` = `'gps'` | `'ip'` | `'cached'`
- [ ] Nessun banner duplicato (toast deduplicate)

### 6.4 Supabase Realtime
- [ ] Allowed Origins (WS) configurati (Supabase Dashboard)
- [ ] Logs Realtime: `SUBSCRIBED`, `TRACK`, `SYNC` per `m1_agents_presence_v1`
- [ ] Nessun `TIMED_OUT` lato server

---

## 7. AZIONI RICHIESTE (OUTSIDE REPO)

1. **Supabase Dashboard:**
   - Aggiungere Allowed Origins (WebSocket) come da §4.1
   - Verificare logs Realtime (§4.2)

2. **Lovable Project Settings:**
   - Aggiungere ENV `VITE_TERRAIN_URL` e `VITE_CONTOUR_URL` (§2.1)
   - Rebuild/restart preview

---

## 8. DEBUG COMANDI (CONSOLE)

```js
// Presenza
window.__M1_DEBUG.presence           // { status, last, error, count }
window.__M1_DEBUG.lastAgentsPresence // [agents con coord] (renderizzati)
window.__M1_DEBUG.agentsPresenceAll  // [tutti online] (per badge count)
window.__M1_DEBUG.agentsPresenceRaw  // raw state

// 3D Terrain
window.__M1_DEBUG.env.TERRAIN        // true se VITE_TERRAIN_URL presente
window.__M1_DEBUG.terrain3D          // { available, active, terrainUrl, error }

// Center
window.__M1_DEBUG.center             // { lastAction, source, error }
```

---

**Report generato:** 2025-10-21  
**Fix applicati:** Immediate track IP-Geo, badge count `{shown}/{all}`, log dev-mode "no coords"  
**ENV & Supabase da configurare:** VITE_TERRAIN_URL, Allowed Origins (WS)

// © 2025 Joseph MULÉ – M1SSION™ – ALL RIGHTS RESERVED – NIYVORA KFT™
