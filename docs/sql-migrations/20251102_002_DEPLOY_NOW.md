# üöÄ A2 Admin Logs - Deploy Now Guide
**¬© 2025 Joseph MUL√â ‚Äì M1SSION‚Ñ¢ ‚Äì ALL RIGHTS RESERVED ‚Äì NIYVORA KFT‚Ñ¢**

## ‚ö° Quick Deploy (3 Passi)

### **STEP 1: Verifica Prerequisiti (30 secondi)**

```sql
-- Esegui questo in Supabase SQL Editor per verificare che A1 sia completo
SELECT 
  EXISTS(SELECT 1 FROM information_schema.tables 
         WHERE table_schema = 'public' AND table_name = 'user_roles') as has_user_roles,
  EXISTS(SELECT 1 FROM information_schema.routines 
         WHERE routine_schema = 'public' AND routine_name = 'has_role') as has_has_role,
  EXISTS(SELECT 1 FROM information_schema.tables 
         WHERE table_schema = 'public' AND table_name = 'admin_logs') as has_admin_logs,
  EXISTS(SELECT 1 FROM public.user_roles WHERE role = 'admin') as has_admin_user;
```

**Expected output:** Tutte le colonne devono essere `true`.

**Se FALSE:** 
- `has_user_roles` = false ‚Üí Esegui prima `20251102_001_user_roles_system.sql` (A1)
- `has_admin_user` = false ‚Üí Assegna admin role al fondatore (vedi A1 SETUP.md)

---

### **STEP 2: Esegui Migrazione (60 secondi)**

1. Apri **Supabase Dashboard** ‚Üí **SQL Editor**
2. Crea **New Query**
3. Copia/incolla **TUTTO il contenuto** di `docs/sql-migrations/20251102_002_admin_logs_extended.sql`
4. Click **RUN** (o Ctrl+Enter)

**Expected output (console):**
```
‚úì Attached audit trigger to table: profiles
‚úì Attached audit trigger to table: prizes
‚úì Attached audit trigger to table: user_clues
‚úì Attached audit trigger to table: user_xp
‚úì Attached audit trigger to table: agent_ranks
‚úì Attached audit trigger to table: m1_units_balance
‚úì Attached audit trigger to table: missions
‚úì Attached audit trigger to table: achievements
‚úì Attached audit trigger to table: user_stats
‚úì Attached audit trigger to table: leaderboards
‚úì Attached audit trigger to table: rewards
‚úì Attached audit trigger to table: notifications
‚úì Attached audit trigger to table: referrals
‚úì Attached audit trigger to table: user_map_areas
‚úì Attached audit trigger to table: subscriptions
```

**Durata:** ~5 secondi

**Se errori:**
- `table "admin_logs" does not exist` ‚Üí Esegui A1 prima
- `function "has_role" does not exist` ‚Üí Esegui A1 prima
- `table "prizes" does not exist` ‚Üí Normale, trigger non creato (tabella non esiste)

---

### **STEP 3: Verifica Installazione (60 secondi)**

Esegui queste 3 query per confermare che tutto funziona:

#### **Query 1: Check extended columns**
```sql
SELECT column_name, data_type 
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'admin_logs'
  AND column_name IN ('record_id', 'old_data', 'new_data');
```
**Expected:** 3 rows (record_id: uuid, old_data: jsonb, new_data: jsonb)

#### **Query 2: Check triggers**
```sql
SELECT COUNT(*) as trigger_count
FROM information_schema.triggers
WHERE trigger_schema = 'public'
  AND trigger_name LIKE 'audit_%';
```
**Expected:** `trigger_count` ‚â• 10 (dipende da quante tabelle esistono)

#### **Query 3: Check views**
```sql
SELECT table_name 
FROM information_schema.views
WHERE table_schema = 'public'
  AND table_name LIKE 'admin_logs_%'
ORDER BY table_name;
```
**Expected:** 2 rows (`admin_logs_readable`, `admin_logs_stats`)

---

## ‚úÖ Deploy Completo!

Se tutti i check sopra passano, il sistema A2 √® **OPERATIVO**.

### **Test Rapido (Opzionale)**

Testa il logging automatico con questo esempio:

```sql
-- 1. Inserisci record test (se tabella prizes esiste)
INSERT INTO public.prizes (id, name, description, value)
VALUES (
  gen_random_uuid(),
  'TEST_A2_DEPLOY',
  'Test automatic logging',
  100
);

-- 2. Verifica log creato automaticamente
SELECT 
  action,
  target_table,
  new_data->>'name' as prize_name,
  created_at
FROM public.admin_logs
WHERE target_table = 'prizes'
ORDER BY created_at DESC
LIMIT 1;

-- 3. Cleanup test data
DELETE FROM public.prizes WHERE name = 'TEST_A2_DEPLOY';

-- 4. Verifica DELETE log
SELECT 
  action,
  target_table,
  old_data->>'name' as deleted_prize,
  created_at
FROM public.admin_logs
WHERE target_table = 'prizes'
  AND action LIKE '%DELETE%'
ORDER BY created_at DESC
LIMIT 1;
```

**Expected:** 2 log entries (INSERT + DELETE) create automaticamente dal trigger.

---

## üìä Cosa Hai Ottenuto

### **Tabelle:**
- ‚úÖ `admin_logs` estesa con record_id, old_data, new_data

### **Functions:**
- ‚úÖ `trigger_log_admin_operation()` - Trigger universale SECURITY DEFINER
- ‚úÖ `log_custom_admin_action()` - Per log manuali
- ‚úÖ `cleanup_old_admin_logs()` - Per data retention

### **Views:**
- ‚úÖ `admin_logs_readable` - Human-readable con email e field diffs
- ‚úÖ `admin_logs_stats` - Dashboard statistiche

### **Triggers (automatici su):**
- ‚úÖ profiles
- ‚úÖ prizes
- ‚úÖ user_clues
- ‚úÖ user_xp
- ‚úÖ agent_ranks
- ‚úÖ m1_units_balance
- ‚úÖ missions
- ‚úÖ achievements
- ‚úÖ user_stats
- ‚úÖ leaderboards
- ‚úÖ rewards
- ‚úÖ notifications
- ‚úÖ referrals
- ‚úÖ subscriptions
- ‚úÖ user_map_areas

### **Security:**
- ‚úÖ RLS: Solo admin vedono tutti i log, moderator vedono i propri
- ‚úÖ Audit trail immutabile (no UPDATE/DELETE)
- ‚úÖ Logging automatico solo per admin/moderator

---

## üîç Query Utili Post-Deploy

### **Visualizza ultimi 10 log**
```sql
SELECT * FROM public.admin_logs_readable
ORDER BY created_at DESC
LIMIT 10;
```

### **Statistiche ultime 24h**
```sql
SELECT * FROM public.admin_logs_stats
WHERE log_date >= CURRENT_DATE
ORDER BY operation_count DESC;
```

### **Trova modifiche a record specifico**
```sql
SELECT * FROM public.admin_logs_readable
WHERE record_id = 'PASTE_UUID_HERE'
ORDER BY created_at DESC;
```

### **Operazioni su tabella specifica**
```sql
SELECT * FROM public.admin_logs_readable
WHERE target_table = 'prizes'
ORDER BY created_at DESC
LIMIT 20;
```

---

## üìö Documentazione Completa

- **Setup dettagliato:** `docs/sql-migrations/20251102_002_admin_logs_SETUP.md`
- **Test suite:** `docs/sql-migrations/20251102_002_admin_logs_TEST.sql`
- **Documentazione completa:** `docs/sql-migrations/20251102_002_admin_logs_README.md`
- **Migrazione SQL:** `docs/sql-migrations/20251102_002_admin_logs_extended.sql`

---

## üö® Troubleshooting

### **"No logs created after operations"**
‚Üí Verifica di essere loggato come admin:
```sql
SELECT public.has_role(auth.uid(), 'admin');
```
Se ritorna `false`, assegna admin role nella tabella `user_roles`.

### **"Permission denied for table admin_logs"**
‚Üí RLS policy blocca accesso. Verifica admin role assegnato.

### **"Trigger overhead causing slowness"**
‚Üí Normale < 5ms overhead. Se > 20ms, escludi colonne large da old_data/new_data.

---

## üéØ Next Steps

1. ‚úÖ **Deploy completato** - Sistema A2 operativo
2. ‚è≥ **Monitor 24h** - Verifica no errori in Postgres logs
3. ‚è≥ **Train team** - Mostra come usare `admin_logs_readable` view
4. ‚è≥ **Setup alerts** - Configura monitoring per suspicious activity
5. ‚è≥ **Phase 3 A1** - Migra legacy policies a `has_role()` (vedi A1 MIGRATION_PLAN.md)

---

**¬© 2025 Joseph MUL√â ‚Äì M1SSION‚Ñ¢ ‚Äì ALL RIGHTS RESERVED ‚Äì NIYVORA KFT‚Ñ¢**
