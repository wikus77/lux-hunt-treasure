<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M1SSION‚Ñ¢ - Push Diagnostics</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #000; color: #fff; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .ok { background: #1f5f3f; border: 1px solid #22c55e; }
        .error { background: #5f1f1f; border: 1px solid #ef4444; }
        .warning { background: #5f4f1f; border: 1px solid #eab308; }
        .info { background: #1f3f5f; border: 1px solid #3b82f6; }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: 500; }
        button:hover { background: #2563eb; }
        button:disabled { background: #374151; cursor: not-allowed; }
        .endpoint { font-family: monospace; font-size: 11px; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin: 5px 0; }
        pre { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        h1 { color: #00D1FF; }
        h2 { color: #fff; border-bottom: 1px solid #333; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ M1SSION‚Ñ¢ Push Diagnostics</h1>
        <p>Tool completo per diagnosi e test delle notifiche push W3C.</p>
        
        <h2>üîç Controlli Sistema</h2>
        <div id="system-checks"></div>
        <button onclick="runSystemChecks()">üîç Esegui Controlli</button>
        
        <h2>üì± Gestione Sottoscrizione</h2>
        <div id="subscription-status"></div>
        <button onclick="subscribeAndSave()" id="subscribe-btn">üìù Sottoscrivi & Salva</button>
        <button onclick="unsubscribe()" id="unsubscribe-btn">üóëÔ∏è Cancella Sottoscrizione</button>
        
        <h2>üß™ Test Invio</h2>
        <div id="send-status"></div>
        <button onclick="testSend()" id="send-btn">üöÄ Invia Test Push</button>
        
        <h2>üìä Database</h2>
        <div id="db-status"></div>
        <button onclick="checkDatabase()">üìã Verifica DB</button>
        
        <div id="logs"></div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://vkjrqirvdvjbemsfzxof.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk';
        const VAPID_PUBLIC_KEY = 'BMkETBgIgFEj0MOINyixtfrde9ZiMbj-5YEtsX8GpnuXpABax28h6dLjmJ7RK6rlZXUJg1N_z3ba0X6E7Qmjj7A';
        
        let currentSubscription = null;
        
        function log(...args) {
            const pre = document.createElement('pre');
            pre.textContent = new Date().toISOString() + ' - ' + args.join(' ');
            document.getElementById('logs').appendChild(pre);
        }
        
        function showStatus(elementId, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById(elementId).appendChild(div);
        }
        
        function clearStatus(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        async function runSystemChecks() {
            clearStatus('system-checks');
            log('Starting system checks...');
            
            // Platform detection
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
            const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
            
            showStatus('system-checks', `
                üîç <strong>Platform Detection</strong><br/>
                Platform: ${navigator.platform}<br/>
                iOS Device: ${isIOS ? '‚úÖ' : '‚ùå'}<br/>
                Safari Browser: ${isSafari ? '‚úÖ' : '‚ùå'}<br/>
                PWA Mode: ${isStandalone ? '‚úÖ' : '‚ùå'}
            `, 'info');
            
            // API Support
            const hasSW = 'serviceWorker' in navigator;
            const hasPush = 'PushManager' in window;
            const hasNotif = 'Notification' in window;
            
            showStatus('system-checks', `
                ‚öôÔ∏è <strong>API Support</strong><br/>
                Service Worker: ${hasSW ? '‚úÖ' : '‚ùå'}<br/>
                Push Manager: ${hasPush ? '‚úÖ' : '‚ùå'}<br/>
                Notifications: ${hasNotif ? '‚úÖ' : '‚ùå'}
            `, hasSW && hasPush && hasNotif ? 'ok' : 'error');
            
            // Permission status
            if (hasNotif) {
                showStatus('system-checks', `
                    üîê <strong>Permissions</strong><br/>
                    Current: ${Notification.permission}<br/>
                    ${Notification.permission === 'granted' ? '‚úÖ Ready to receive notifications' : 
                      Notification.permission === 'denied' ? '‚ùå Notifications blocked' : 
                      '‚ö†Ô∏è Permission not requested yet'}
                `, Notification.permission === 'granted' ? 'ok' : 'warning');
            }
            
            // Check existing subscription
            if (hasSW && hasPush) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        const subscription = await registration.pushManager.getSubscription();
                        if (subscription) {
                            currentSubscription = subscription;
                            const endpoint = subscription.endpoint;
                            const isApple = endpoint.includes('web.push.apple.com') || endpoint.includes('api.push.apple.com');
                            const isFCM = endpoint.includes('fcm.googleapis.com');
                            
                            showStatus('system-checks', `
                                ‚úÖ <strong>Active Subscription</strong><br/>
                                Endpoint Type: ${isApple ? 'üçé Apple Push' : isFCM ? 'üü¢ FCM' : '‚ùì Other'}<br/>
                                <div class="endpoint">Endpoint: ${endpoint}</div>
                            `, 'ok');
                            
                            document.getElementById('subscribe-btn').textContent = 'üîÑ Aggiorna Sottoscrizione';
                            document.getElementById('unsubscribe-btn').disabled = false;
                            document.getElementById('send-btn').disabled = false;
                        } else {
                            showStatus('system-checks', '‚ÑπÔ∏è No active subscription found', 'info');
                            document.getElementById('subscribe-btn').textContent = 'üìù Sottoscrivi & Salva';
                            document.getElementById('unsubscribe-btn').disabled = true;
                            document.getElementById('send-btn').disabled = true;
                        }
                    }
                } catch (error) {
                    showStatus('system-checks', `‚ùå Error checking subscription: ${error.message}`, 'error');
                }
            }
        }
        
        async function subscribeAndSave() {
            clearStatus('subscription-status');
            log('Starting subscription process...');
            
            try {
                // Request permission
                if (Notification.permission !== 'granted') {
                    showStatus('subscription-status', 'üîê Requesting notification permission...', 'info');
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permission denied');
                    }
                }
                
                // Register service worker
                showStatus('subscription-status', '‚öôÔ∏è Registering service worker...', 'info');
                const registration = await navigator.serviceWorker.register('/sw-test.js', { scope: '/' });
                await navigator.serviceWorker.ready;
                log('Service worker registered');
                
                // Create subscription
                showStatus('subscription-status', 'üìù Creating push subscription...', 'info');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                currentSubscription = subscription;
                const endpoint = subscription.endpoint;
                const isApple = endpoint.includes('web.push.apple.com') || endpoint.includes('api.push.apple.com');
                
                showStatus('subscription-status', `
                    ‚úÖ <strong>Subscription Created</strong><br/>
                    Type: ${isApple ? 'üçé Apple Push Service' : 'üü¢ FCM'}<br/>
                    <div class="endpoint">Endpoint: ${endpoint}</div>
                `, 'ok');
                
                // Save to Supabase
                showStatus('subscription-status', 'üíæ Saving to database...', 'info');
                const subscriptionData = {
                    keys: {
                        p256dh: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('p256dh')))),
                        auth: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('auth'))))
                    },
                    endpoint: subscription.endpoint,
                    ua: navigator.userAgent,
                    platform: endpoint.includes('web.push.apple.com') ? 'apple' : 'fcm',
                    user_id: 'push-diag-test-' + Date.now()
                };
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/push_subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify(subscriptionData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('subscription-status', `‚úÖ <strong>Saved to Database</strong><br/>Type: ${result.endpoint_type}`, 'ok');
                    log('Subscription saved:', result);
                    
                    document.getElementById('subscribe-btn').textContent = 'üîÑ Aggiorna Sottoscrizione';
                    document.getElementById('unsubscribe-btn').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                } else {
                    const error = await response.text();
                    throw new Error(`Database save failed: ${response.status} - ${error}`);
                }
                
            } catch (error) {
                showStatus('subscription-status', `‚ùå <strong>Subscription Failed</strong><br/>${error.message}`, 'error');
                log('Subscription error:', error);
            }
        }
        
        async function unsubscribe() {
            clearStatus('subscription-status');
            log('Unsubscribing...');
            
            try {
                if (currentSubscription) {
                    await currentSubscription.unsubscribe();
                    currentSubscription = null;
                    
                    showStatus('subscription-status', '‚úÖ Successfully unsubscribed', 'ok');
                    document.getElementById('subscribe-btn').textContent = 'üìù Sottoscrivi & Salva';
                    document.getElementById('unsubscribe-btn').disabled = true;
                    document.getElementById('send-btn').disabled = true;
                } else {
                    showStatus('subscription-status', '‚ÑπÔ∏è No active subscription to remove', 'info');
                }
            } catch (error) {
                showStatus('subscription-status', `‚ùå Unsubscribe failed: ${error.message}`, 'error');
            }
        }
        
        async function testSend() {
            clearStatus('send-status');
            log('Sending test push...');
            
            if (!currentSubscription) {
                showStatus('send-status', '‚ö†Ô∏è No active subscription. Subscribe first.', 'warning');
                return;
            }
            
            try {
                const payload = {
                    endpoint: currentSubscription.endpoint,
                    title: 'M1SSION‚Ñ¢ Test Push ‚úÖ',
                    body: 'Push diagnostics test successful!',
                    url: '/push-diag.html'
                };
                
                showStatus('send-status', 'üöÄ Sending test notification...', 'info');
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/push_send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('send-status', `
                        ‚úÖ <strong>Push Sent</strong><br/>
                        Sent: ${result.sent}<br/>
                        Failed: ${result.failed}<br/>
                        Removed: ${result.removed}
                    `, result.sent > 0 ? 'ok' : 'warning');
                    log('Push result:', result);
                } else {
                    const error = await response.text();
                    throw new Error(`Send failed: ${response.status} - ${error}`);
                }
                
            } catch (error) {
                showStatus('send-status', `‚ùå <strong>Send Failed</strong><br/>${error.message}`, 'error');
                log('Send error:', error);
            }
        }
        
        async function checkDatabase() {
            clearStatus('db-status');
            log('Checking database...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/push_subscriptions?select=*&order=created_at.desc&limit=5`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    }
                });
                
                if (response.ok) {
                    const subscriptions = await response.json();
                    
                    if (subscriptions.length > 0) {
                        const appleCount = subscriptions.filter(s => s.endpoint && (s.endpoint.includes('web.push.apple.com') || s.endpoint.includes('api.push.apple.com'))).length;
                        const fcmCount = subscriptions.filter(s => s.endpoint && s.endpoint.includes('fcm.googleapis.com')).length;
                        
                        showStatus('db-status', `
                            üìä <strong>Database Status</strong><br/>
                            Total subscriptions: ${subscriptions.length}<br/>
                            üçé Apple Push: ${appleCount}<br/>
                            üü¢ FCM: ${fcmCount}<br/>
                            Latest: ${new Date(subscriptions[0].created_at).toLocaleString()}
                        `, 'ok');
                        
                        // Show recent endpoints
                        subscriptions.forEach((sub, i) => {
                            const isApple = sub.endpoint && (sub.endpoint.includes('web.push.apple.com') || sub.endpoint.includes('api.push.apple.com'));
                            showStatus('db-status', `
                                ${i + 1}. ${isApple ? 'üçé' : 'üü¢'} <div class="endpoint">${sub.endpoint || 'N/A'}</div>
                                Created: ${new Date(sub.created_at).toLocaleString()}
                            `, 'info');
                        });
                    } else {
                        showStatus('db-status', '‚ÑπÔ∏è No subscriptions found in database', 'info');
                    }
                } else {
                    throw new Error(`Database check failed: ${response.status}`);
                }
                
            } catch (error) {
                showStatus('db-status', `‚ùå Database check failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-run system checks on load
        window.addEventListener('load', runSystemChecks);
    </script>
</body>
</html>