<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M1SSION‚Ñ¢ - Push Diagnostics</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #000; color: #fff; }
        .status { padding: 10px; margin: 10px 0; border-radius: 8px; }
        .ok { background: #1f5f3f; border: 1px solid #22c55e; }
        .error { background: #5f1f1f; border: 1px solid #ef4444; }
        .warning { background: #5f4f1f; border: 1px solid #eab308; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .endpoint { font-family: monospace; font-size: 12px; word-break: break-all; }
        pre { background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç M1SSION‚Ñ¢ Push Diagnostics</h1>
    <p>Tool completo per diagnosticare Web Push W3C + VAPID su tutti i browser.</p>
    
    <div id="results"></div>
    
    <button onclick="testVAPIDKey()">üîë Test VAPID Key</button>
    <button onclick="testGetSubscription()">üì± Check getSubscription()</button>
    <button onclick="testSubscribe()">üöÄ Test W3C Subscribe</button>
    <button onclick="testSend()">üì§ Test Send Push</button>
    <button onclick="clearAll()">üßπ Clear All</button>
    
    <script>
        // VAPID KEY ALIGNED (M1SSION‚Ñ¢ PRODUCTION)
        const VAPID_KEY = 'BCboRJTDYR4W2lbR4_BLoSJUkbORYxmqyBi0oDZvbMUbwU-dq4U-tOkMLlpTSL9OYDAgQDmcswZ0eY8wRK5BV_U';
        const SUPA = 'https://vkjrqirvdvjbemsfzxof.supabase.co';
        const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZranJxaXJ2ZHZqYmVtc2Z6eG9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzQyMjYsImV4cCI6MjA2MDYxMDIyNn0.rb0F3dhKXwb_110--08Jsi4pt_jx-5IWwhi96eYMxBk';
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
            // Auto-scroll to bottom
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Base64url decoder OBBLIGATORIO per VAPID
        const b64urlToUint8 = (s) => {
            const p = '='.repeat((4 - s.length % 4) % 4);
            const b64 = (s + p).replace(/-/g, '+').replace(/_/g, '/');
            const raw = atob(b64);
            return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
        };
        
        async function testVAPIDKey() {
            document.getElementById('results').innerHTML = '';
            
            try {
                log('üîë Testing VAPID key format...', 'info');
                log(`üîë Key: ${VAPID_KEY}`, 'info');
                log(`üîë Key length: ${VAPID_KEY.length}`, 'info');
                
                const vapidBytes = b64urlToUint8(VAPID_KEY);
                log(`üîë Decoded to ${vapidBytes.length} bytes`, vapidBytes.length === 65 ? 'ok' : 'error');
                log(`üîë First 8 bytes: [${Array.from(vapidBytes.slice(0, 8)).map(x => x.toString(16).padStart(2, '0')).join(', ')}]`, 'info');
                
                if (vapidBytes.length === 65) {
                    log('‚úÖ VAPID key format is CORRECT (P-256)', 'ok');
                } else {
                    log(`‚ùå VAPID key format is INCORRECT! Expected 65 bytes for P-256, got ${vapidBytes.length}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå VAPID key test failed: ${error.message}`, 'error');
            }
        }
        
        async function testGetSubscription() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    log('‚ùå No service worker registration found', 'error');
                    return;
                }
                
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    const subJSON = subscription.toJSON();
                    log('‚úÖ Active subscription found!', 'ok');
                    log(`<pre>${JSON.stringify(subJSON, null, 2)}</pre>`, 'info');
                    
                    // Verify subscription completeness
                    const isApple = subJSON.endpoint.includes('web.push.apple.com');
                    const isFCM = subJSON.endpoint.includes('fcm.googleapis.com');
                    
                    log(`üçé Apple Push: ${isApple}`, isApple ? 'ok' : 'info');
                    log(`üü¢ FCM Push: ${isFCM}`, isFCM ? 'ok' : 'info');
                    log(`üîë Has p256dh: ${!!subJSON.keys?.p256dh}`, !!subJSON.keys?.p256dh ? 'ok' : 'error');
                    log(`üîë Has auth: ${!!subJSON.keys?.auth}`, !!subJSON.keys?.auth ? 'ok' : 'error');
                    
                } else {
                    log('‚ö†Ô∏è No active subscription found', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testSubscribe() {
            try {
                log('üöÄ Starting W3C Web Push subscription test...', 'info');
                
                // Request permission
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permission denied');
                    }
                }
                
                // Register service worker (/sw.js ONLY - unified)
                const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                await navigator.serviceWorker.ready;
                log('‚úÖ Service worker registered: /sw.js', 'ok');
                
                // OBBLIGATORIO: sempre usare applicationServerKey
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: b64urlToUint8(VAPID_KEY)
                });
                
                const subJSON = subscription.toJSON();
                log('‚úÖ Subscription created successfully!', 'ok');
                log(`<pre>${JSON.stringify(subJSON, null, 2)}</pre>`, 'info');
                
                // Save to Supabase usando subscription.toJSON()
                const savePayload = {
                    subscription: subJSON,
                    client_id: crypto.randomUUID(),
                    platform: subJSON.endpoint.includes('web.push.apple.com') ? 'apple' : 'fcm',
                    ua: navigator.userAgent
                };
                
                log('üíæ Saving to Supabase...', 'info');
                const saveResponse = await fetch(`${SUPA}/functions/v1/push_subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ANON}`,
                        'apikey': ANON
                    },
                    body: JSON.stringify(savePayload)
                });
                
                const saveText = await saveResponse.text();
                log(`üíæ Save response (${saveResponse.status}):`, saveResponse.ok ? 'ok' : 'error');
                log(`<pre>${saveText}</pre>`, 'info');
                
            } catch (error) {
                log(`‚ùå Subscription failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testSend() {
            try {
                log('üöÄ Testing push send...', 'info');
                
                const payload = {
                    user_id: '495246c1-9154-4f01-a428-7f37fe230180', // wikus77@hotmail.it
                    title: 'M1SSION‚Ñ¢ Push Test ‚úÖ',
                    body: 'W3C Web Push working perfectly!',
                    data: { url: '/push-diag.html', src: 'diagnostics' }
                };
                
                log(`üì§ Send payload: <pre>${JSON.stringify(payload, null, 2)}</pre>`, 'info');
                
                const sendResponse = await fetch(`${SUPA}/functions/v1/push_send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ANON}`,
                        'apikey': ANON
                    },
                    body: JSON.stringify(payload)
                });
                
                const sendText = await sendResponse.text();
                log(`üöÄ Send response (${sendResponse.status}):`, sendResponse.ok ? 'ok' : 'error');
                log(`<pre>${sendText}</pre>`, 'info');
                
                if (sendResponse.ok) {
                    const result = JSON.parse(sendText);
                    if (result.sent > 0) {
                        log('üéâ CHECK YOUR DEVICE FOR THE NOTIFICATION!', 'ok');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Send error: ${error.message}`, 'error');
            }
        }
        
        async function clearAll() {
            try {
                document.getElementById('results').innerHTML = '';
                
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        await subscription.unsubscribe();
                        log('‚úÖ Subscription cleared', 'ok');
                    } else {
                        log('‚ÑπÔ∏è No subscription to clear', 'info');
                    }
                } else {
                    log('‚ÑπÔ∏è No service worker registration', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Clear failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-run environment check on load
        window.addEventListener('load', () => {
            log(`üîç Platform: ${navigator.platform}`, 'info');
            log(`üîç User Agent: ${navigator.userAgent.substring(0, 80)}...`, 'info');
            log(`üì± Max Touch Points: ${navigator.maxTouchPoints}`, 'info');
            log(`üîî Notification Permission: ${Notification.permission}`, 'info');
            log(`‚öôÔ∏è Service Worker Supported: ${'serviceWorker' in navigator}`, 'info');
            log(`üì® Push Manager Supported: ${'PushManager' in window}`, 'info');
            testVAPIDKey();
        });
    </script>
</body>
</html>