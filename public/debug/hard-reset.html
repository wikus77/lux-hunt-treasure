<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M1SSION‚Ñ¢ - Hard Reset PWA</title>
    <style>
        body { 
            font-family: system-ui; 
            padding: 20px; 
            background: #000; 
            color: #fff; 
            line-height: 1.6; 
            text-align: center;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .warning { background: #5f4f1f; border: 1px solid #eab308; }
        .ok { background: #1f5f3f; border: 1px solid #22c55e; }
        .error { background: #5f1f1f; border: 1px solid #ef4444; }
        button { 
            background: #ef4444; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px; 
            font-weight: 600;
            font-size: 16px;
        }
        button:hover { background: #dc2626; }
        button:disabled { background: #374151; cursor: not-allowed; }
        h1 { color: #ef4444; }
        .back-link { color: #3b82f6; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ M1SSION‚Ñ¢ Hard Reset</h1>
        <p>Strumento per eliminare completamente Service Worker e cache PWA</p>
        
        <div class="status warning">
            ‚ö†Ô∏è <strong>ATTENZIONE</strong><br/>
            Questa operazione eliminer√† definitivamente:
            <ul style="text-align: left; margin: 10px 0;">
                <li>Tutti i Service Worker registrati</li>
                <li>Tutte le cache PWA (immagini, API, pagine)</li>
                <li>Sottoscrizioni push attive</li>
            </ul>
            Utile per risolvere problemi di caricamento o Service Worker bloccati.
        </div>
        
        <div id="status"></div>
        
        <button onclick="performHardReset()" id="reset-btn">
            üßπ ESEGUI HARD RESET
        </button>
        
        <br/><br/>
        <a href="/" class="back-link">‚Üê Torna alla Home</a>
        
        <div id="logs" style="margin-top: 20px; text-align: left;"></div>
    </div>
    
    <script>
        function log(message) {
            const div = document.createElement('div');
            div.style.fontSize = '12px';
            div.style.margin = '2px 0';
            div.style.color = '#888';
            div.textContent = new Date().toISOString() + ' - ' + message;
            document.getElementById('logs').appendChild(div);
        }
        
        function showStatus(message, type = 'ok') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('status').appendChild(div);
        }
        
        function clearStatus() {
            document.getElementById('status').innerHTML = '';
        }
        
        async function performHardReset() {
            clearStatus();
            const resetBtn = document.getElementById('reset-btn');
            resetBtn.disabled = true;
            resetBtn.textContent = 'üîÑ Resetting...';
            
            try {
                log('Starting hard reset process...');
                
                // Step 1: Unregister all service workers
                showStatus('üìù Step 1: Unregistering Service Workers...', 'warning');
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`Found ${registrations.length} service worker(s)`);
                    
                    for (const registration of registrations) {
                        await registration.unregister();
                        log(`Unregistered SW: ${registration.scope}`);
                    }
                    
                    showStatus('‚úÖ Service Workers unregistered', 'ok');
                } else {
                    showStatus('‚ÑπÔ∏è Service Workers not supported', 'warning');
                }
                
                // Step 2: Clear all caches
                showStatus('üìù Step 2: Clearing all caches...', 'warning');
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`Found ${cacheNames.length} cache(s): ${cacheNames.join(', ')}`);
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`Deleted cache: ${cacheName}`);
                    }
                    
                    showStatus('‚úÖ All caches cleared', 'ok');
                } else {
                    showStatus('‚ÑπÔ∏è Cache API not supported', 'warning');
                }
                
                // Step 3: Clear local storage and session storage
                showStatus('üìù Step 3: Clearing storage...', 'warning');
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    showStatus('‚úÖ Local/Session storage cleared', 'ok');
                    log('Storage cleared');
                } catch (error) {
                    log(`Storage clear error: ${error.message}`);
                }
                
                // Step 4: Final confirmation
                showStatus('üéâ <strong>Hard Reset Completato!</strong><br/>La pagina verr√† ricaricata automaticamente in 3 secondi...', 'ok');
                log('Hard reset completed successfully');
                
                // Auto-reload after 3 seconds
                setTimeout(() => {
                    log('Reloading page...');
                    window.location.reload(true);
                }, 3000);
                
            } catch (error) {
                showStatus(`‚ùå <strong>Reset Error</strong><br/>${error.message}`, 'error');
                log(`Reset error: ${error.message}`);
                resetBtn.disabled = false;
                resetBtn.textContent = 'üßπ ESEGUI HARD RESET';
            }
        }
        
        // Auto-detect if this page was loaded due to SW issues
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('auto') === 'true') {
                showStatus('üîç <strong>Rilevato problema automatico</strong><br/>Si consiglia di eseguire il reset', 'warning');
            }
        });
    </script>
</body>
</html>